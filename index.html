<!DOCTYPE html>
<html>
<head>
  <title>Atomic Pool</title>
</head>

<body style="background-image: url('img/bg.jpg')">

<div id="container" style="display: flex; justify-content: center;">
<canvas id="gameCanvas" width="550" height="550" style="border:2px solid #000000; background-image: url('img/background.jpg')"></canvas>
</div>

<div id="scoreContainer" style="display: block; text-align: center;"></div>

<script>  // ===================================================


const playerForce = 0.1;
const traction = 0.95; // on stage 1
const traction3 = 0.995; // on stage 3
const slingForse = 0.001;

const nBalls = 2;


// =============================================================

var score;
var scores = [];
var gameStage;
var fast = false;
var pause = false;
var gameOver = false;
var showFPS = false;
var edge = 0;


var player;
var balls;
var goal;
var prize;
var ballRebounce = false;


var scoreElement = document.createElement('div');
scoreContainer.appendChild(scoreElement);
scoreElement.style.fontSize = '32px';

var score10Element = document.createElement('div');
scoreContainer.appendChild(score10Element);
score10Element.style.fontSize = '32px';

var fpsOut = document.createElement('div');
document.body.appendChild(fpsOut);
fpsOut.style.fontSize = '24px';

var debugOut = document.createElement('div');
document.body.appendChild(debugOut);
debugOut.style.fontSize = '28px';

var canvas = document.getElementById("gameCanvas");
var ctx = canvas.getContext("2d");
ctx.imageSmoothingEnabled = true;
//ctx.imageSmoothingQuality = 'high';


//var backgroundImage = new Image();
//backgroundImage.src = "img/background.jpg";
//var edgeImage = new Image();
//edgeImage.src = "img/edge.jpg";


var bounceSound = new Sound('sounds/bounceball.mp3');
var bounceWallSound = bounceSound;


// =============================================


var keys = {};
document.onkeydown = document.onkeyup = function(e) {
	keys[e.keyCode] = e.type == 'keydown';
	//db(e.keyCode);
	
	// Space
	if (e.keyCode == 32 && e.type == 'keydown' && gameStage==1) {
		gameStage = 2;
		player.vx = player.vy = 0;
	}
	
	// Pause on P or Escape
	if (e.type == 'keydown' && (e.keyCode == 80 || e.keyCode == 27)) {
		pause = pause ? false : true; 
	}
	
	// Fast on Ctrl 
	if (e.keyCode == 17) {
		fast = e.type == 'keydown';
	}
	
	// fps on `
	if (e.keyCode == 192 && e.type == 'keydown') {
		showFPS = !showFPS;
		if (!showFPS) fpsOut.innerHTML = '';
	}
};


function db(v) {
	debugOut.innerHTML = v;
}


function Sound(filename) {
		this.sounds = [];
		var nSounds = 5;
		this.currentSound = 0;
		for (var i = 0; i < nSounds; i++) {
				this.sounds.push(new Audio(filename));
		}

		this.play = function() {
				this.sounds[this.currentSound].play();
				this.currentSound = (this.currentSound + 1) % nSounds;
		}
}

function playBounceWallSound(v) {
	if (Math.abs(v) > 0.5) bounceWallSound.play();
}

function playBounceBallSound() {
	if (gameStage > 1) bounceSound.play();
}



var frameTime = 0, lastLoop = new Date(), thisLoop;
function countFPS() {
	const FPSfilterStrength = 20;
	var thisFrameTime = (thisLoop = new Date()) - lastLoop;
	frameTime += (thisFrameTime - frameTime) / FPSfilterStrength;
	lastLoop = thisLoop;
}

setInterval(function(){
	if (showFPS) {
		fpsOut.innerHTML = (1000/frameTime).toFixed(1) + " fps";
	}
}, 1000);


function updateScore() {
	if (gameStage == 3) {
		score = 50 - Math.floor(goalDistance()/goalCircles) * 10;
		if (score < 0) score = 0;
		if (prize.used) score *= 2;
		scoreElement.innerHTML = 'Score: ' + score;
	}
}


// ===============================================


function rndPosition(r) {
	var x = r + Math.random() * (canvas.width - r*2);
	var y = r + Math.random() * (canvas.height - r*2);
	return {x: x, y: y};
}


function doCirclesNotOverlap(circle1, circle2) {
	var dx = circle1.x - circle2.x;
	var dy = circle1.y - circle2.y;
	var distance = Math.sqrt(dx * dx + dy * dy);
	return distance > circle1.radius + circle2.radius;
}


function doesCircleNotOverlap(circle, circles) {
	return circles.every((elem) => doCirclesNotOverlap(circle, elem));
}


function AdjustPlayerCollisionPosition(ball) {
	// Calculate quadratic coefficients
	let a = player.vx**2 + player.vy**2;
	let b = 2 * (player.vx * (player.x - ball.x) + player.vy * (player.y - ball.y));
	let c = (player.x - ball.x)**2 + (player.y - ball.y)**2 - (player.radius + ball.radius)**2;

	// Calculate discriminant
	let discriminant = b**2 - 4 * a * c;

	
	if (discriminant > 0) { // there is a collision
		// Calculate time of collision
		let t = (-b - Math.sqrt(discriminant)) / (2 * a);

		// Calculate position of player at time of collision
		player.x = player.x + player.vx * t;
		player.y = player.y + player.vy * t;
	}
}


function CheckBallCollision() {
    for (let i = 0; i < balls.length; i++) {
        let ball = balls[i];
        let dx = player.x - ball.x;
        let dy = player.y - ball.y;
        let distance = Math.sqrt(dx * dx + dy * dy);
        if (distance < player.radius + ball.radius) {
            return ball;
        }
    }
    return null;
}


function playerRebounce(collidingBall) {
    let normal = {x: player.x - collidingBall.x, y: player.y - collidingBall.y};
    let normalMagnitude = Math.sqrt(normal.x * normal.x + normal.y * normal.y);
    normal.x /= normalMagnitude;
    normal.y /= normalMagnitude;
    let dotProduct = player.vx * normal.x + player.vy * normal.y;
    player.vx = player.vx - 2 * dotProduct * normal.x;
    player.vy = player.vy - 2 * dotProduct * normal.y;
}


// =================================================


const playerRad = 10;
function Player(x, y) {
	this.x = x;
	this.y = y;
	this.radius = playerRad;
	this.vx = 0;
	this.vy = 0;
	
	this.sling = {x: x, y: y};
	
} 

Player.prototype.speed = function() {
  return Math.sqrt(this.vx * this.vx + this.vy * this.vy);
}

Player.prototype.slingLength = function() {
	var dx = this.x - this.sling.x;
	var dy = this.y - this.sling.y;
	return Math.sqrt(dx * dx + dy * dy);
}


Player.prototype.update = function() {
	if (gameStage == 1) {
		//db(this.speed());
		var ds = playerForce * (this.speed() + 0.2);
		if (ds > playerForce*3) ds -= (ds - playerForce*3)*2;
		if (keys[37]) {            // left arrow
				this.vx -= ds;
		}
		if (keys[38]) {            // up arrow
				this.vy -= ds;
		}
		if (keys[39]) {            // right arrow
				this.vx += ds;
		}
		if (keys[40] || keys[12]) { // down arrow
				this.vy += ds;
		}
	} else if (gameStage == 2) {
		this.vx -= (this.x - this.sling.x) * slingForse;
		this.vy -= (this.y - this.sling.y) * slingForse;
		
		if (this.slingLength() < this.radius) {
			gameStage = 3;
		}
	}
	
	
	if (gameStage == 1) {
	this.vx *= traction;
	this.vy *= traction;
	} else if (gameStage == 3) {
		var v = this.speed()
		if (v < traction3) { 
			this.vx *= 0.95 + v * 0.05;
			this.vy *= 0.95 + v * 0.05;
		} else {
			this.vx *= traction3;
			this.vy *= traction3;
		}
	}
	
	this.x += this.vx;
	this.y += this.vy;
	
	this.bounceWall();
	
	let collidingBall = CheckBallCollision();
	if (collidingBall != null) {
			AdjustPlayerCollisionPosition(collidingBall);
			playerRebounce(collidingBall);
			if (gameStage == 3) ballRebounce = true;
			playBounceBallSound();
			if (gameStage == 2) gameStage = 3;
	}
	
	if (gameStage == 3 && player.speed() < 0.01) {
		gameStage = 4;
		player.vx = player.vy = 0;
		
		if (!ballRebounce && score > 0) {
			score = 0;
			scoreElement.innerHTML = 'Score: 0' + '  (you have to rebounce off the ball)';
		}
		
		var ln = scores.push(score);
		if (ln > 10) scores.shift();
		var score10 = 0;
		scores.forEach(e => score10 += e);
		score10Element.innerHTML = 'Score for the last 10 shots: ' + score10;
		
		setTimeout(startGame(), 3000);
	}
	
}// Player.update()


Player.prototype.bounceWall = function() {
	if (this.x - this.radius < edge) {
			let overlap = edge + this.radius - this.x;
			this.x += 2 * overlap;
			this.vx *= -1;
			playBounceWallSound(this.vx);
	} else if (this.x + this.radius > canvas.width-edge) { 
			let overlap = this.x + this.radius - canvas.width+edge;
			this.x -= 2 * overlap;
			this.vx *= -1;
			playBounceWallSound(this.vx);
	}
	if (this.y - this.radius < edge) {
			let overlap = edge + this.radius - this.y;
			this.y += 2 * overlap;
			this.vy *= -1;
			playBounceWallSound(this.vy);
	} else if (this.y + this.radius > canvas.height-edge) { 
			let overlap = this.y + this.radius - canvas.height+edge;
			this.y -= 2 * overlap;
			this.vy *= -1;
			playBounceWallSound(this.vy);
	}
}


Player.prototype.draw = function() {
	
	if (gameStage < 3) {
		this.drawSling();
	}
	
	//ctx.drawImage(playerImage, this.x - this.radius, this.y - 	this.radius, this.radius * 2, this.radius * 2);
	
	ctx.beginPath();
	ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
	ctx.fillStyle = "brown";
	ctx.fill();
	ctx.strokeStyle = "black";
	ctx.stroke();
	
	
} // Player.draw()


Player.prototype.drawSling = function() {
	var dx = this.x - this.sling.x;
	var dy = this.y - this.sling.y;
	var length = Math.sqrt(dx * dx + dy * dy);
	const nlinks = 15;
	var r = this.radius/(Math.sqrt(this.slingLength())+5)*5;
	for (i=0; i<nlinks; i++) {
		var x = this.sling.x + i * dx/nlinks;
		var y = this.sling.y + i * dy/nlinks;
		ctx.beginPath();
		ctx.arc(x, y, r, 0, Math.PI * 2);
		ctx.fillStyle = (i == 0) ? "black" : "#993300";
		ctx.fill();
	}
}


// ===============================================


function Ball(x, y, r) {
	this.x = x;
	this.y = y;
	this.radius = r;
	
}


Ball.prototype.draw = function() {
	ctx.beginPath();
	ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
	ctx.fillStyle = "#222222";
	ctx.fill();
	ctx.strokeStyle = "black";
	ctx.stroke();
	
}

// ===================================================


function goalDistance() {
	var dx = player.x - goal.x;
	var dy = player.y - goal.y;
	return Math.sqrt(dx*dx + dy*dy);
}


const goalCircles = 50;
function drawGoal() {
	ctx.beginPath();
	ctx.arc(goal.x, goal.y, goal.radius, 0, Math.PI * 2);
	ctx.fillStyle = "blue";
	ctx.fill();
	ctx.strokeStyle = "black";
	ctx.stroke();
	
	if (gameStage > 2) {
		var dx = player.x - goal.x;
		var dy = player.y - goal.y;
		var dist = Math.sqrt(dx*dx + dy*dy);
		for (var i=1; i < 6; i++) {
			ctx.beginPath();
			ctx.arc(goal.x, goal.y, i*goalCircles, 0, Math.PI * 2);
			ctx.setLineDash(i*goalCircles < dist ? [] : [5, 10]);
			ctx.strokeStyle = "blue";
			ctx.stroke();
		}
		ctx.setLineDash([]);
	}
}

// ===================================================


function updatePrize() {
	if (prize.used || gameStage != 3) return;
	
	let dx = player.x - prize.x;
	let dy = player.y - prize.y;
	let distance = Math.sqrt(dx * dx + dy * dy);
	if (distance < player.radius + prize.radius) {
		prize.used = true;
	}
}


function drawPrize() {
	if (prize.used) return;
	
	ctx.beginPath();
	ctx.globalAlpha = 0.5;
	ctx.arc(prize.x, prize.y, prize.radius, 0, Math.PI * 2);
	ctx.fillStyle = "green";
	ctx.fill();
	ctx.strokeStyle = "black";
	ctx.stroke();
	ctx.globalAlpha = 1;
}


// ====================================================

startGame();
function startGame() {
	gameStage = 1;

	var p = rndPosition(playerRad);
	player = new Player(p.x, p.y);
	ballRebounce = false;

	// balls
	
	balls = [];
	for (var i = 0; i < nBalls; i++) {
		//var all = []; all.concat(player, balls);
		var all = balls.concat(player);
		var r = (i+5)*20; // 100, 120
		do {
			var p = rndPosition(r);
			var ball = new Ball(p.x, p.y, r);
		} while (!doesCircleNotOverlap(ball, all));
		balls.push(ball);
	}

	// goal
	var all = balls.concat({x: player.x, y: player.y, radius: 200}); // goal distance > 200px
	do {
		var p = rndPosition(player.radius);
		goal = {x: p.x, y: p.y, radius: player.radius}
	} while (!doesCircleNotOverlap(goal, all));
	goal.radius /= 2;

	// prize
	var all = balls.concat(
		{x: player.x, y: player.y, radius: 200},
		{x: goal.x, y: goal.y, radius: 200}
		);
	do {
		var p = rndPosition(player.radius*4);
		prize = {x: p.x, y: p.y, radius: player.radius*4}
	} while (!doesCircleNotOverlap(prize, all));
	prize.radius *= 0.75;
	prize.used = false;

}


function update() {
	player.update();
	updatePrize();
	updateScore();
	
}



function draw() {
	//drawBackground();
	ctx.clearRect(0, 0, canvas.width, canvas.height);
	
	drawGoal();
	drawPrize();
	
	player.draw();
	
	balls.forEach(function(ball) {
			ball.draw();
	});
	
}



// Main Loop
setInterval(function() {
	if (gameOver || pause) return;
	
	update();
	
	if (fast) { // 3 times faster
		update();
		update();
	}
	
	draw();
	
	countFPS()
}, 15); // 67fps


</script>
</body>
</html>